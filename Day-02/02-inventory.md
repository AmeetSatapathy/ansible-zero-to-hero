# Inventory 

Ansible inventory file is a fundamental component of Ansible that defines the hosts (remote systems) that you want to manage and the groups those hosts belong to. The inventory file can be static (a simple text file) or dynamic (generated by a script). It provides Ansible with the information about the remote nodes to communicate with during its operations.

## Static Inventory

A static inventory file is typically a plain text file (usually named hosts or inventory) and is structured in INI or YAML format. Here are examples of both formats:

### INI Format

```
# inventory file: hosts

[webservers]
web1.example.com
web2.example.com

[dbservers]
db1.example.com
db2.example.com

[all:vars]
ansible_user=admin
ansible_ssh_private_key_file=/path/to/key
```

### YAML

```
# inventory file: hosts.yaml

all:
  vars:
    ansible_user: admin
    ansible_ssh_private_key_file: /path/to/key
  children:
    webservers:
      hosts:
        web1.example.com:
        web2.example.com:
    dbservers:
      hosts:
        db1.example.com:
        db2.example.com:
```

## Dynamic Inventory

A dynamic inventory is generated by a script or plugin and can be used for environments where hosts are constantly changing (e.g., cloud environments). The script or plugin fetches the list of hosts from a source like AWS, GCP, or any other dynamic source.

Here is an example of a dynamic inventory script for AWS EC2:

```
#!/usr/bin/env python

import json
import boto3

def get_aws_ec2_inventory():
    ec2 = boto3.client('ec2')
    instances = ec2.describe_instances()
    inventory = {
        'all': {
            'hosts': [],
            'vars': {
                'ansible_user': 'ec2-user',
                'ansible_ssh_private_key_file': '/path/to/key'
            }
        },
        '_meta': {
            'hostvars': {}
        }
    }

    for reservation in instances['Reservations']:
        for instance in reservation['Instances']:
            if instance['State']['Name'] == 'running':
                public_ip = instance['PublicIpAddress']
                inventory['all']['hosts'].append(public_ip)
                inventory['_meta']['hostvars'][public_ip] = {
                    'ansible_host': public_ip
                }

    print(json.dumps(inventory, indent=2))

if __name__ == '__main__':
    get_aws_ec2_inventory()
```

## Usage

```
ansible-playbook -i inventory <Adhoc command or Playbook.yml>
```

Detailed explanation of the code
=================================
Certainly! Here's a detailed line-by-line explanation of the Python script:

### Script Overview:
This script interacts with the AWS EC2 API using the `boto3` library to fetch information about running EC2 instances and then formats the data into an Ansible-compatible inventory in JSON format.

---

### Line-by-Line Breakdown:

```python
#!/usr/bin/env python
```
- **Explanation**: This is called a "shebang" line. It tells the operating system to use the specified interpreter (in this case, Python) to run the script. It ensures the script will be executed with the correct interpreter when run directly from the command line.
- **Usage**: On Unix-like systems (Linux, macOS), this allows you to run the script directly (e.g., `./script.py`) without having to call Python explicitly.

---

```python
import json
import boto3
```
- **Explanation**:
  - `import json`: Imports the `json` module, which is used to handle JSON data. Here, it will be used to format the Ansible inventory as JSON.
  - `import boto3`: Imports the `boto3` library, which is the AWS SDK for Python. This library allows you to interact with AWS services like EC2, S3, etc. In this script, it's used to interact with EC2.

---

```python
def get_aws_ec2_inventory():
```
- **Explanation**: This defines a function named `get_aws_ec2_inventory`. The function will be responsible for gathering information about EC2 instances and building the inventory.

---

```python
    ec2 = boto3.client('ec2')
```
- **Explanation**: 
  - `boto3.client('ec2')` creates a low-level client object for interacting with the EC2 service in AWS.
  - The `client` method is used to initiate a connection to AWS EC2. It communicates with the AWS EC2 API to describe, manage, and perform operations on EC2 instances.
  - The `ec2` object now provides methods to interact with EC2 resources.

---

```python
    instances = ec2.describe_instances()
```
- **Explanation**: 
  - `describe_instances()` is a method of the `ec2` client that retrieves information about all EC2 instances in your account.
  - It returns a response in the form of a dictionary that includes details about the instances, such as their IDs, public IP addresses, states, and more.

---

```python
    inventory = {
        'all': {
            'hosts': [],
            'vars': {
                'ansible_user': 'ec2-user',
                'ansible_ssh_private_key_file': '/path/to/key'
            }
        },
        '_meta': {
            'hostvars': {}
        }
    }
```
- **Explanation**:
  - This initializes a dictionary `inventory` to structure the Ansible inventory format:
    - **`'all'`**: This is a top-level group in Ansible. It contains all hosts that should be included in the inventory.
      - **`'hosts'`**: An empty list that will hold the public IP addresses of the running EC2 instances.
      - **`'vars'`**: Contains global variables for all hosts. Here, it defines:
        - `ansible_user`: Specifies the default SSH user for EC2 instances (`ec2-user` is common for Amazon Linux).
        - `ansible_ssh_private_key_file`: Path to the SSH private key used for authentication when connecting to instances.
    - **`'_meta'`**: This is a special section in the inventory used to define host-specific variables.
      - **`'hostvars'`**: This dictionary will store variables for each host, keyed by the public IP address.

---

```python
    for reservation in instances['Reservations']:
```
- **Explanation**: 
  - The `instances` object returned by `describe_instances()` contains a list of reservations (groups of instances). Each reservation includes one or more EC2 instances.
  - This loop iterates over each reservation in the `Reservations` list.

---

```python
        for instance in reservation['Instances']:
```
- **Explanation**: 
  - For each reservation, we have a list of instances (within the `Instances` key). This inner loop iterates over each instance in the reservation.

---

```python
            if instance['State']['Name'] == 'running':
```
- **Explanation**: 
  - The `State` key in the instance metadata contains information about the current state of the instance (e.g., `running`, `stopped`, `terminated`).
  - This checks if the instance is in the `'running'` state before processing it. Only running instances are added to the inventory.

---

```python
                public_ip = instance.get('PublicIpAddress')
```
- **Explanation**: 
  - This line tries to retrieve the `PublicIpAddress` of the EC2 instance using the `.get()` method. This method safely retrieves the value, returning `None` if the key is not found.
  - Some EC2 instances might not have a public IP (e.g., private-only instances), so this method ensures the script won't throw an error if the key is missing.

---

```python
                inventory['all']['hosts'].append(public_ip)
```
- **Explanation**: 
  - This adds the retrieved `public_ip` of the running instance to the `hosts` list under the `all` group in the Ansible inventory.

---

```python
                inventory['_meta']['hostvars'][public_ip] = {
                    'ansible_host': public_ip
                }
```
- **Explanation**: 
  - This line adds a host-specific variable for the instance using its public IP as the key.
  - The variable `ansible_host` is set to the instance's public IP address, which Ansible will use when connecting to the host.

---

```python
    print(json.dumps(inventory, indent=2))
```
- **Explanation**: 
  - `json.dumps()` converts the `inventory` Python dictionary into a JSON string.
  - The `indent=2` argument formats the JSON output with an indentation level of 2 spaces, making the output more readable.

---

```python
if __name__ == '__main__':
    get_aws_ec2_inventory()
```
- **Explanation**: 
  - This is the standard Python entry point for running the script directly. The `if __name__ == '__main__':` block ensures that the `get_aws_ec2_inventory()` function will only run when the script is executed directly, not when it's imported as a module in another script.
  - Calls the `get_aws_ec2_inventory()` function to execute the logic defined above.

---

### Summary:
- The script retrieves EC2 instance information using `boto3`.
- It filters for running instances, extracts their public IP addresses, and builds an Ansible inventory in JSON format.
- The output can be used directly by Ansible to manage EC2 instances dynamically.
